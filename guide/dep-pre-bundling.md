# Попереднє збирання залежностей

Коли ви вперше запускаєте `vite`, Vite попередньо збирає залежності вашого проекту перед завантаженням вашого сайту локально. Це робиться автоматично і прозоро за замовчуванням.

## Чому

Це Vite виконує те, що ми називаємо "попереднє збирання залежностей". Цей процес має дві цілі:

1. **Сумісність з CommonJS та UMD:** Під час розробки Vite обслуговує весь код як нативний ESM. Тому Vite повинен спочатку конвертувати залежності, які постачаються як CommonJS або UMD, у ESM.

  Під час конвертації залежностей CommonJS, Vite виконує розумний аналіз імпорту, щоб іменовані імпорти до модулів CommonJS працювали як очікується, навіть якщо експорти призначаються динамічно (наприклад, React):

  ```js
  // працює як очікується
  import React, { useState } from 'react'
  ```

2. **Продуктивність:** Vite конвертує залежності ESM з багатьма внутрішніми модулями в один модуль, щоб покращити продуктивність завантаження сторінки.

  Деякі пакети постачають свої збірки ES модулів як багато окремих файлів, що імпортують один одного. Наприклад, [`lodash-es` має понад 600 внутрішніх модулів](https://unpkg.com/browse/lodash-es/)! Коли ми робимо `import { debounce } from 'lodash-es'`, браузер одночасно надсилає понад 600 HTTP-запитів! Хоча сервер не має проблем з їх обробкою, велика кількість запитів створює мережеве перевантаження на стороні браузера, що спричиняє помітне уповільнення завантаження сторінки.

  Попередньо зібравши `lodash-es` в один модуль, нам тепер потрібен лише один HTTP-запит!

::: tip ПРИМІТКА
Попереднє збирання залежностей застосовується лише в режимі розробки і використовує `esbuild` для конвертації залежностей у ESM. У виробничих збірках замість цього використовується `@rollup/plugin-commonjs`.
:::

## Автоматичне виявлення залежностей

Якщо існуючий кеш не знайдено, Vite буде сканувати ваш вихідний код і автоматично виявляти імпорти залежностей (тобто "чисті імпорти", які очікують бути вирішеними з `node_modules`) і використовувати ці знайдені імпорти як точки входу для попереднього збирання. Попереднє збирання виконується за допомогою `esbuild`, тому воно зазвичай дуже швидке.

Після того, як сервер вже запущено, якщо буде виявлено новий імпорт залежності, який ще не знаходиться в кеші, Vite повторно запустить процес збирання залежностей і перезавантажить сторінку, якщо це необхідно.

## Монорепозиторії та зв'язані залежності

У налаштуванні монорепозиторію залежність може бути зв'язаним пакетом з того ж репозиторію. Vite автоматично виявляє залежності, які не вирішуються з `node_modules`, і розглядає зв'язану залежність як вихідний код. Він не буде намагатися збирати зв'язану залежність, а натомість аналізуватиме список залежностей зв'язаної залежності.

Однак це вимагає, щоб зв'язана залежність експортувалася як ESM. Якщо ні, ви можете додати залежність до [`optimizeDeps.include`](/config/dep-optimization-options.md#optimizedeps-include) і [`build.commonjsOptions.include`](/config/build-options.md#build-commonjsoptions) у вашій конфігурації.

```js twoslash [vite.config.js]
import { defineConfig } from 'vite'
// ---cut---
export default defineConfig({
  optimizeDeps: {
   include: ['linked-dep'],
  },
  build: {
   commonjsOptions: {
    include: [/linked-dep/, /node_modules/],
   },
  },
})
```

При внесенні змін до зв'язаної залежності перезапустіть сервер розробки з опцією командного рядка `--force`, щоб зміни набули чинності.

## Налаштування поведінки

За замовчуванням евристика виявлення залежностей може бути не завжди бажаною. У випадках, коли ви хочете явно включити/виключити залежності зі списку, використовуйте [опції конфігурації `optimizeDeps`](/config/dep-optimization-options.md).

Типовий випадок використання `optimizeDeps.include` або `optimizeDeps.exclude` - це коли у вас є імпорт, який не можна безпосередньо виявити у вихідному коді. Наприклад, можливо, імпорт створюється в результаті перетворення плагіна. Це означає, що Vite не зможе виявити імпорт під час початкового сканування - він зможе виявити його лише після того, як файл буде запитано браузером і перетворено. Це призведе до негайного повторного збирання сервера після його запуску.

І `include`, і `exclude` можна використовувати для вирішення цієї проблеми. Якщо залежність велика (з багатьма внутрішніми модулями) або є CommonJS, тоді ви повинні включити її; Якщо залежність мала і вже є дійсним ESM, ви можете виключити її і дозволити браузеру завантажити її безпосередньо.

Ви також можете додатково налаштувати esbuild за допомогою опції [`optimizeDeps.esbuildOptions`](/config/dep-optimization-options.md#optimizedeps-esbuildoptions). Наприклад, додавання плагіна esbuild для обробки спеціальних файлів у залежностях або зміна [цілі збірки](https://esbuild.github.io/api/#target).

## Кешування

### Кеш файлової системи

Vite кешує попередньо зібрані залежності в `node_modules/.vite`. Він визначає, чи потрібно повторно виконати крок попереднього збирання, на основі кількох джерел:

- Вміст файлу блокування менеджера пакетів, наприклад, `package-lock.json`, `yarn.lock`, `pnpm-lock.yaml` або `bun.lockb`.
- Час модифікації папки патчів.
- Відповідні поля у вашому `vite.config.js`, якщо вони присутні.
- Значення `NODE_ENV`.

Крок попереднього збирання потрібно буде повторно виконати лише тоді, коли одне з вищезазначених зміниться.

Якщо з якоїсь причини ви хочете примусити Vite повторно зібрати залежності, ви можете або запустити сервер розробки з опцією командного рядка `--force`, або вручну видалити кеш-директорію `node_modules/.vite`.

### Кеш браузера

Запити на вирішені залежності сильно кешуються за допомогою HTTP-заголовків `max-age=31536000,immutable`, щоб покращити продуктивність перезавантаження сторінки під час розробки. Після кешування ці запити більше не будуть звертатися до сервера розробки. Вони автоматично анулюються за допомогою доданого запиту версії, якщо встановлено іншу версію (як відображено у файлі блокування менеджера пакетів). Якщо ви хочете налагоджувати свої залежності, вносячи локальні зміни, ви можете:

1. Тимчасово вимкнути кеш через вкладку Мережа у інструментах розробника вашого браузера;
2. Перезапустити сервер розробки Vite з прапором `--force`, щоб повторно зібрати залежності;
3. Перезавантажити сторінку.
