# API середовища

:::warning Експериментальний
Початкова робота над цим API була представлена у Vite 5.1 під назвою "Vite Runtime API". Цей посібник описує переглянуте API, перейменоване на API середовища. Це API буде випущено у Vite 6 як експериментальне. Ви вже можете протестувати його в останній версії `vite@6.0.0-beta.x`.

Ресурси:

- [Обговорення зворотного зв'язку](https://github.com/vitejs/vite/discussions/16358), де ми збираємо відгуки про нові API.
- [PR API середовища](https://github.com/vitejs/vite/pull/16471), де нове API було реалізовано та переглянуто.

Будь ласка, поділіться з нами своїми відгуками, тестуючи пропозицію.
:::

## Формалізація середовищ

Vite 6 формалізує концепцію середовищ. До Vite 5 існували два неявних середовища (`client` і, за бажанням, `ssr`). Нове API середовища дозволяє користувачам і авторам фреймворків створювати стільки середовищ, скільки потрібно для відображення роботи їхніх додатків у виробництві. Ця нова можливість вимагала великого внутрішнього рефакторингу, але було докладено багато зусиль для забезпечення зворотної сумісності. Початкова мета Vite 6 - плавно перевести екосистему на нову основну версію, відкладаючи впровадження цих нових експериментальних API, поки достатня кількість користувачів не мігрує, а автори фреймворків і плагінів не перевірять новий дизайн.

## Закриття розриву між збіркою та розробкою

Для простого SPA/MPA нові API середовищ не відкриваються для конфігурації. Внутрішньо Vite застосовуватиме параметри до середовища `client`, але це поняття не потрібно знати під час налаштування Vite. Конфігурація та поведінка з Vite 5 повинні працювати безперебійно.

Коли ми переходимо до типової програми з серверною стороною рендерингу (SSR), у нас буде два середовища:

- `client`: запускає додаток у браузері.
- `server`: запускає додаток у node (або інших серверних середовищах), який рендерить сторінки перед відправкою їх у браузер.

Під час розробки Vite виконує серверний код у тому ж процесі Node, що й сервер розробки Vite, що дає наближення до виробничого середовища. Однак сервери також можуть працювати в інших середовищах JS, таких як [Cloudflare's workerd](https://github.com/cloudflare/workerd), які мають різні обмеження. Сучасні додатки також можуть працювати в більш ніж двох середовищах, наприклад, у браузері, сервері node та сервері edge. Vite 5 не дозволяв належним чином представляти ці середовища.

Vite 6 дозволяє користувачам налаштовувати свій додаток під час збірки та розробки для відображення всіх його середовищ. Під час розробки тепер можна використовувати один сервер розробки Vite для запуску коду в кількох різних середовищах одночасно. Вихідний код додатка все ще трансформується сервером розробки Vite. На додаток до спільного HTTP-сервера, проміжного програмного забезпечення, вирішеної конфігурації та конвеєра плагінів, сервер розробки Vite тепер має набір незалежних середовищ розробки. Кожне з них налаштоване на максимально точне відповідність виробничому середовищу та підключене до середовища розробки, де виконується код (для workerd серверний код тепер може виконуватися в miniflare локально). У клієнті браузер імпортує та виконує код. В інших середовищах модульний виконавець отримує та оцінює трансформований код.

![Середовища Vite](../images/vite-environments.svg)

## Конфігурація середовищ

Для SPA/MPA конфігурація буде схожа на Vite 5. Внутрішньо ці параметри використовуються для налаштування середовища `client`.

```js
export default defineConfig({
  build: {
    sourcemap: false,
  },
  optimizeDeps: {
    include: ['lib'],
  },
})
```

Це важливо, оскільки ми хочемо зберегти Vite доступним і уникнути введення нових концепцій, поки вони не знадобляться.

Якщо додаток складається з кількох середовищ, ці середовища можна налаштувати явно за допомогою параметра конфігурації `environments`.

```js
export default {
  build: {
    sourcemap: false,
  },
  optimizeDeps: {
    include: ['lib'],
  },
  environments: {
    server: {},
    edge: {
      resolve: {
        noExternal: true,
      },
    },
  },
}
```

Якщо не вказано явно, середовище успадковує налаштовані параметри конфігурації верхнього рівня (наприклад, нові середовища `server` і `edge` успадкують параметр `build.sourcemap: false`). Невелика кількість параметрів верхнього рівня, таких як `optimizeDeps`, застосовується лише до середовища `client`, оскільки вони погано працюють, коли застосовуються за замовчуванням до серверних середовищ. Середовище `client` також можна налаштувати явно через `environments.client`, але ми рекомендуємо робити це за допомогою параметрів верхнього рівня, щоб конфігурація клієнта залишалася незмінною при додаванні нових середовищ.

Інтерфейс `EnvironmentOptions` надає всі параметри для кожного середовища. Існують параметри середовища, які застосовуються як до `build`, так і до `dev`, такі як `resolve`. Існують також `DevEnvironmentOptions` і `BuildEnvironmentOptions` для параметрів, специфічних для розробки та збірки (наприклад, `dev.warmup` або `build.outDir`). Деякі параметри, такі як `optimizeDeps`, застосовуються лише до розробки, але залишаються на верхньому рівні замість вкладення в `dev` для зворотної сумісності.

```ts
interface EnvironmentOptions {
  define?: Record<string, any>
  resolve?: EnvironmentResolveOptions
  optimizeDeps: DepOptimizationOptions
  consumer?: 'client' | 'server'
  dev: DevOptions
  build: BuildOptions
}
```

Інтерфейс `UserConfig` розширюється від інтерфейсу `EnvironmentOptions`, дозволяючи налаштовувати клієнта та параметри за замовчуванням для інших середовищ, налаштованих через параметр `environments`. Середовище `client` і серверне середовище під назвою `ssr` завжди присутні під час розробки. Це забезпечує зворотну сумісність із `server.ssrLoadModule(url)` і `server.moduleGraph`. Під час збірки середовище `client` завжди присутнє, а середовище `ssr` присутнє лише в тому випадку, якщо воно явно налаштоване (використовуючи `environments.ssr` або для зворотної сумісності `build.ssr`). Додаток не обов'язково повинен використовувати назву `ssr` для свого середовища SSR, він може назвати його, наприклад, `server`.

```ts
interface UserConfig extends EnvironmentOptions {
  environments: Record<string, EnvironmentOptions>
  // інші параметри
}
```

Зверніть увагу, що властивість верхнього рівня `ssr` буде застарілою, як тільки API середовища стане стабільним. Цей параметр має ту ж роль, що й `environments`, але для середовища за замовчуванням `ssr` і дозволяє налаштовувати лише невелику кількість параметрів.

## Користувацькі екземпляри середовища

Доступні низькорівневі API конфігурації, щоб постачальники середовищ могли надавати середовища з належними параметрами за замовчуванням для своїх середовищ виконання. Ці середовища також можуть запускати інші процеси або потоки для виконання модулів під час розробки в середовищі, ближчому до виробничого.

```js
import { customEnvironment } from 'vite-environment-provider'

export default {
  build: {
    outDir: '/dist/client',
  },
  environments: {
    ssr: customEnvironment({
      build: {
        outDir: '/dist/ssr',
      },
    }),
  },
}
```

## Зворотна сумісність

Поточні API сервера Vite ще не застаріли та є зворотно сумісними з Vite 5. Нове API середовища є експериментальним.

`server.moduleGraph` повертає змішаний вигляд графів модулів клієнта та ssr. Зворотно сумісні змішані вузли модулів будуть повернуті з усіх його методів. Така ж схема використовується для вузлів модулів, переданих до `handleHotUpdate`.

Ми не рекомендуємо переходити на API середовища поки що. Ми прагнемо, щоб значна частина користувачів перейшла на Vite 6, щоб плагіни не потрібно було підтримувати у двох версіях. Перегляньте розділ майбутніх змін, що ламають сумісність, для отримання інформації про майбутні застарівання та шлях оновлення:

- [`this.environment` у хуках](/changes/this-environment-in-hooks)
- [HMR `hotUpdate` Plugin Hook](/changes/hotupdate-hook)
- [Перехід на API для кожного середовища](/changes/per-environment-apis)
- [SSR за допомогою API `ModuleRunner`](/changes/ssr-using-modulerunner)
- [Спільні плагіни під час збірки](/changes/shared-plugins-during-build)

## Цільові користувачі

Цей посібник надає основні концепції про середовища для кінцевих користувачів.

Автори плагінів мають більш послідовний API для взаємодії з поточною конфігурацією середовища. Якщо ви створюєте на основі Vite, посібник [Посібник з плагінів API середовища](./api-environment-plugins.md) описує розширені API плагінів, доступні для підтримки кількох користувацьких середовищ.

Фреймворки можуть вирішити, на якому рівні відкривати середовища. Якщо ви автор фреймворку, продовжуйте читати [Посібник з API середовища для фреймворків](./api-environment-frameworks), щоб дізнатися про програмну сторону API середовища.

Для постачальників середовищ посібник [Посібник з API середовища для середовищ виконання](./api-environment-runtimes.md) пояснює, як пропонувати користувацькі середовища для використання фреймворками та користувачами.
